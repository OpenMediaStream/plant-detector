<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Agro-WebRTC</title>
</head>
<style>
    .frame {
        position: absolute;
        left: 263px;
        top: 400px;
        z-index: 1;
    }
    .text {
        position: absolute;
        left: 263px;
        top: 370px;
        z-index: 2;
    }

    .cam {
        position: absolute;
        left: 0px;
        top: 0px;
        z-index: 0;
    }
</style>

<body>
    <canvas class="frame" id="myCanvas" width="151" height="153" style="border:5px solid red"></canvas>
    <text class="text" style="background-color:whitesmoke; color:red; font-family:arial; font-size: 25px;" >Pimenteira</text>

    <input type="hidden" name="webrtc-url" id="webrtc-url"
        value="https://mediaserver.maua.br/stream/27aec28e-6181-4753-9acd-0456a75f0289/channel/0/webrtc" />

    <video class="cam" id="webrtc-video" autoplay muted playsinline controls
        style="max-width: 100%; max-height: 100%"></video>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function startPlay(videoEl, url) {
                const webrtc = new RTCPeerConnection({
                    iceServers: [
                        {
                            urls: ["stun:stun.l.google.com:19302"],
                        },
                    ],
                    sdpSemantics: "unified-plan",
                });
                webrtc.ontrack = function (event) {
                    console.log(event.streams.length + " track is delivered");
                    videoEl.srcObject = event.streams[0];
                    videoEl.play();
                };
                webrtc.addTransceiver("video", { direction: "sendrecv" });
                webrtc.onnegotiationneeded =
                    async function handleNegotiationNeeded() {
                        const offer = await webrtc.createOffer();

                        await webrtc.setLocalDescription(offer);

                        fetch(url, {
                            method: "POST",
                            body: new URLSearchParams({
                                data: btoa(webrtc.localDescription.sdp),
                            }),
                        })
                            .then((response) => response.text())
                            .then((data) => {
                                try {
                                    webrtc.setRemoteDescription(
                                        new RTCSessionDescription({
                                            type: "answer",
                                            sdp: atob(data),
                                        })
                                    );
                                } catch (e) {
                                    console.warn(e);
                                }
                            });
                    };

                const webrtcSendChannel = webrtc.createDataChannel(
                    "rtsptowebSendChannel"
                );
                webrtcSendChannel.onopen = (event) => {
                    console.log(`${webrtcSendChannel.label} has opened`);
                    webrtcSendChannel.send("ping");
                };
                webrtcSendChannel.onclose = (_event) => {
                    console.log(`${webrtcSendChannel.label} has closed`);
                    startPlay(videoEl, url);
                };
                webrtcSendChannel.onmessage = (event) => console.log(event.data);
            }

            const videoEl = document.querySelector("#webrtc-video");
            const webrtcUrl = document.querySelector("#webrtc-url").value;

            console.log(`videoEl: ${videoEl}`);
            console.log(`webrtcUrl: ${webrtcUrl}`);

            startPlay(videoEl, webrtcUrl);
        });
    </script>
</body>

</html>